<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phone Phreak Emulator</title>
    <meta name="description" content="Test your phreaking skills by hacking this phone line." />
    <meta name="author" content="Kevin McDonald" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://phreak.kmcd.dev/" />
    <meta property="og:title" content="Phone Phreak Emulator" />
    <meta property="og:description" content="Test your phreaking skills by hacking this phone line." />
    <meta property="og:image" content="https://phreak.kmcd.dev/social.png" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://phreak.kmcd.dev/" />
    <meta property="twitter:title" content="Phone Phreak Emulator" />
    <meta property="twitter:description" content="Test your phreaking skills by hacking this phone line." />
    <meta property="twitter:image" content="https://phreak.kmcd.dev/social.png" />

    <!-- Favicon - Optional but recommended -->
    <!-- <link rel="icon" href="/favicon.ico" sizes="any"> -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <!-- <link rel="apple-touch-icon" href="/apple-touch-icon.png"> -->

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'VT323', monospace;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%; /* Prevent iOS text size adjust */
            -ms-text-size-adjust: 100%; /* IE10+ */
            text-size-adjust: 100%; /* Standard */
        }
        .phone-body {
            background-color: #d2b48c; /* tan */
            border: 4px solid #8b4513; /* saddlebrown */
            box-shadow: 10px 10px 5px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.3);
        }
        .display-screen {
            background-color: #334155; /* slate-700 */
            border: 3px solid #1e293b; /* slate-800 */
            color: #fde047; /* yellow-300 */
            text-shadow: 0 0 5px #fde047, 0 0 10px #fde047;
            padding: 1rem;
            height: 120px;
            overflow-y: auto;
            font-size: 1.25rem;
        }
        .btn-phone {
            transition: all 0.1s ease;
            box-shadow: 0 4px #6b7280;
            border-bottom: 1px solid #4b5563;
        }
        .btn-phone:active {
            transform: translateY(4px);
            box-shadow: 0 0 #6b7280;
        }
        .btn-hook-up {
             background-color: #ef4444; /* red-500 */
             border-color: #b91c1c; /* red-700 */
        }
        .btn-hook-down {
             background-color: #22c55e; /* green-500 */
             border-color: #15803d; /* green-700 */
        }
        .led {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        .led-off { background-color: #4b5563; box-shadow: inset 0 0 5px rgba(0,0,0,0.5);}
        .led-on { background-color: #ef4444; box-shadow: 0 0 10px #ef4444, 0 0 20px #ef4444; }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="phone-body max-w-lg w-full p-6 rounded-2xl">
        
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="text-4xl text-gray-800">Phreak-Box 2600</h1>
            <p class="text-gray-700">A Vintage TelCo Emulator</p>
        </div>

        <!-- Display Screen -->
        <div id="display" class="display-screen rounded-lg mb-4 font-mono">
        </div>

        <!-- Controls and Status -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-2"> 
                <div id="status-led" class="led led-off"></div>
                <span id="status-text" class="text-lg text-gray-700">OFF-HOOK</span>
                <span id="mute-toggle-link" 
                      class="text-sm text-blue-600 hover:text-blue-800 underline cursor-pointer hidden ml-1">
                      {/* Content will be (mute) or (unmute) via JS */}
                </span>
            </div>
            <button id="start-button" class="btn-phone bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                Start
            </button>
        </div>

        <!-- Audio Visualizer -->
        <canvas id="visualizer" class="w-full h-20 bg-gray-900 rounded-lg mb-2"></canvas>
        
        <!-- Frequency Display -->
        <div class="text-center mb-4 text-gray-700">
            <p>Detected Frequency: <span id="freq-display" class="font-bold text-lg text-gray-800">---</span> Hz</p>
        </div>

        <!-- Tone Buttons -->
        <div class="grid grid-cols-2 gap-4">
            <button id="play-2600hz" class="btn-phone bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg text-lg">Play 2600Hz Tone</button>
            <button id="hangup-button" class="btn-phone btn-hook-up text-white font-bold py-3 px-4 rounded-lg text-lg">Hang Up</button>
        </div>
        
        <!-- Instructions -->
        <div class="mt-6 p-4 bg-tan-200 rounded-lg border border-gray-600 text-gray-800">
            <h3 class="font-bold text-lg mb-2">How to Use:</h3>
            <ol class="list-decimal list-inside text-base space-y-1">
                <li>Press <strong>Start</strong> to activate the system and enable your microphone.</li>
                <li>You'll hear a dial tone. The system is now listening.</li>
                <li><strong>Whistle</strong> or use an external source to play a <a href="https://en.wikipedia.org/wiki/2600_hertz" target="_blank" class="text-blue-800 hover:text-blue-600 underline"><strong>2600Hz</strong></a> tone.</li>
                <li>If the tone is detected, the "TRUNK SEIZED" LED will light up, and you'll disconnect from the local exchange.</li>
                <li>The system is now open. Silence will reconnect the dial tone.</li>
                <li>Press <strong>Hang Up</strong> to reset the system at any time.</li>
            </ol>
        </div>

        <!-- Footer -->
        <div class="text-center mt-4 text-gray-700 text-sm">
             <p><a href="https://kmcd.dev" target="_blank" class="text-blue-800 hover:text-blue-600 underline">kmcd.dev</a></p>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const startButton = document.getElementById('start-button');
        const hangupButton = document.getElementById('hangup-button');
        const play2600Button = document.getElementById('play-2600hz');
        const display = document.getElementById('display');
        const visualizerCanvas = document.getElementById('visualizer');
        const statusLed = document.getElementById('status-led');
        const statusText = document.getElementById('status-text');
        const muteToggleLink = document.getElementById('mute-toggle-link');
        const freqDisplay = document.getElementById('freq-display'); // New element

        // --- Audio Context and Tone Generation ---
        let analyser;
        let microphone;
        let dialTone, busySignal, tone2600;
        const canvasCtx = visualizerCanvas.getContext('2d');

        // --- Game State ---
        const TARGET_FREQUENCY = 2600;
        const FREQUENCY_TOLERANCE = 30; // How close the detected freq needs to be
        const SILENCE_THRESHOLD = -70; // dB
        const TONE_DURATION_THRESHOLD = 500; // milliseconds
        let isRunning = false;
        let isTrunkSeized = false;
        let isDialToneMuted = false;
        let animationFrameId;
        let toneStartTime = null; // Timestamp for when 2600Hz tone detection began

        // --- Utility Functions ---
        function logToDisplay(message) {
            const p = document.createElement('p');
            p.textContent = `> ${message}`;
            display.appendChild(p);
            display.scrollTop = display.scrollHeight;
        }

        // --- Sound Setup (Tone.js) ---
        function setupSounds() {
            // Dispose of previous instances if they exist to prevent memory leaks or duplicate sounds
            if (dialTone) dialTone.dispose();
            if (busySignal) busySignal.dispose();
            // tone2600 is an Oscillator, its destination is the filter.
            // Disposing the filter (or the main context) will handle it,
            // but explicit disposal is also fine if it were connected to destination directly.
            if (tone2600) tone2600.dispose();


            // Use a low-pass filter to make sounds more "lo-fi" like a phone
            const filter = new Tone.Filter(800, "lowpass").toDestination();

            dialTone = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.9, release: 1 },
                volume: -40 // Further reduced volume for dial tone
            }).connect(filter);

            busySignal = new Tone.Synth({
                oscillator: { type: "square" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.9, release: 0.1 },
                volume: -18
            }).connect(filter);

            tone2600 = new Tone.Oscillator(2600, "sine").connect(filter);
        }

        // --- UI Update Functions ---
        function updateStatusDisplay(baseStatus) {
            // baseStatus can be "DIAL TONE", "TRUNK SEIZED", "OFF-HOOK"
            if (baseStatus === "DIAL TONE") {
                if (isDialToneMuted) {
                    statusText.textContent = "DIAL TONE MUTED";
                    muteToggleLink.textContent = "(unmute)";
                } else {
                    statusText.textContent = "DIAL TONE";
                    muteToggleLink.textContent = "(mute)";
                }
                muteToggleLink.classList.remove('hidden');
            } else { // "TRUNK SEIZED" or "OFF-HOOK"
                statusText.textContent = baseStatus;
                muteToggleLink.classList.add('hidden');
            }
        }

        function playDialTone() {
            updateStatusDisplay("DIAL TONE"); // Update text and link visibility first

            if (isDialToneMuted) {
                if (dialTone && typeof dialTone.releaseAll === 'function') {
                    dialTone.releaseAll(); // Ensure it's stopped if it was somehow playing
                }
                return; // Don't play if muted
            }
            // If not muted:
            stopAllSounds();
            if (dialTone) {
                dialTone.triggerAttack(["G4", "F4"]); // Common dial tone frequencies
            }
        }
        function playBusySignal() {
            stopAllSounds();
            if (busySignal) {
                // This is a simplified busy signal effect
                Tone.Transport.start();
                new Tone.Loop(time => {
                    // Ensure busySignal still exists and system is running, in case of rapid stop/start
                    if (busySignal && isRunning) {
                        busySignal.triggerAttackRelease("A#4", "0.25s", time);
                    }
                }, "0.5s").start(0);
            }
        }

        function stopAllSounds() {
            if (dialTone && typeof dialTone.releaseAll === 'function') {
                dialTone.releaseAll();
            }
            if (busySignal && typeof busySignal.triggerRelease === 'function') {
                busySignal.triggerRelease();
            }
            if (tone2600 && tone2600.state === "started") {
                tone2600.stop();
            }
            Tone.Transport.stop();
            Tone.Transport.cancel(); // Clears all scheduled events
        }

        // --- Audio Processing ---
        async function startAudioProcessing() {
            // Tone.start() should have been called by the user gesture (startButton click)
            // and ensures Tone.context is active.
            if (Tone.context.state === 'suspended') {
                await Tone.context.resume(); // Resume if somehow still suspended
            }

            setupSounds();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = Tone.context.createMediaStreamSource(stream);
                analyser = Tone.context.createAnalyser();
                analyser.fftSize = 4096; // Increased FFT size for better frequency resolution
                microphone.connect(analyser);

                isRunning = true;
                isTrunkSeized = false;
                startButton.disabled = true;
                startButton.classList.add('opacity-50', 'cursor-not-allowed');
                logToDisplay("Mic access granted. System active.");
                // statusText.textContent = "DIAL TONE"; // playDialTone will handle this via updateStatusDisplay
                playDialTone();

                visualize();
                detectTone();
            } catch (err) {
                logToDisplay("Error accessing microphone.");
                console.error('Error accessing microphone:', err);
                stopAudioProcessing(); // Ensure cleanup if mic access fails
            }
        }

        async function stopAudioProcessing() { // Made function async
            if (microphone) {
                microphone.disconnect();
                microphone.mediaStream.getTracks().forEach(track => track.stop());
                microphone = null;
            }
            if(analyser){
                analyser.disconnect();
                analyser = null;
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }

            stopAllSounds();
            // Synths will be disposed by setupSounds() on next start.

            isRunning = false;
            isTrunkSeized = false;
            updateUIForHangup();
            logToDisplay("System reset. Press START.");

            // Dispose of the entire Tone.js context and reset its 'started' state.
            // This allows Tone.start() to create a fresh context on the next run.
            // Tone.dispose() is async and handles closing the context.
            // Call dispose() on the Tone.context instance.
            // This cleans up Tone.js resources and closes the underlying native AudioContext.
            if (Tone.context && typeof Tone.context.dispose === 'function' && Tone.context.state !== 'closed') {
                await Tone.context.dispose();
            }
        }

        // --- Core Detection Logic ---
        function detectTone() {
            if (!analyser || !isRunning) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Float32Array(bufferLength);
            analyser.getFloatFrequencyData(dataArray);

            // Find peak frequency
            let peak_volume = -Infinity;
            let peak_index = -1;
            for (let i = 0; i < bufferLength; i++) {
                if (dataArray[i] > peak_volume) {
                    peak_volume = dataArray[i];
                    peak_index = i;
                }
            }
            const peak_freq = peak_index * Tone.context.sampleRate / analyser.fftSize;

            const isToneCurrentlyDetected = Math.abs(peak_freq - TARGET_FREQUENCY) < FREQUENCY_TOLERANCE && peak_volume > SILENCE_THRESHOLD - 10;

            if (isToneCurrentlyDetected) {
                freqDisplay.textContent = Math.round(peak_freq); // Display frequency when tone is being detected
                if (toneStartTime === null) {
                    toneStartTime = Tone.now() * 1000; // Start timer (ms)
                } else {
                    const elapsedTime = (Tone.now() * 1000) - toneStartTime;
                    if (elapsedTime >= TONE_DURATION_THRESHOLD) {
                        if (!isTrunkSeized) {
                            isTrunkSeized = true;
                            logToDisplay("2600Hz DETECTED! TRUNK SEIZED.");
                            statusLed.classList.add('led-on');
                            statusLed.classList.remove('led-off');
                            updateStatusDisplay("TRUNK SEIZED");
                            stopAllSounds();
                            if (busySignal) {
                                busySignal.triggerAttackRelease("C2", "0.1s", Tone.now() + 0.05);
                            }
                            // No need to call playDialTone() here as the trunk is seized
                        }
                    }
                }
            } else {
                // Tone is not currently detected in this frame
                toneStartTime = null; // Reset timer

                if (peak_volume < SILENCE_THRESHOLD) {
                    if (isTrunkSeized) {
                        logToDisplay("Silence detected. Releasing trunk...");
                        isTrunkSeized = false;
                        statusLed.classList.remove('led-on');
                        statusLed.classList.add('led-off');
                        // playDialTone() also calls updateStatusDisplay("DIAL TONE")
                        playDialTone();
                    }
                    freqDisplay.textContent = '---'; // Reset on silence
                } else {
                    // Not silent, and not the target tone, just display the current peak frequency
                    freqDisplay.textContent = Math.round(peak_freq);
                }
            }

            requestAnimationFrame(detectTone);
        }


        // --- UI Updates & Visualization ---
        function updateUIForHangup() {
             startButton.disabled = false;
             startButton.classList.remove('opacity-50', 'cursor-not-allowed');
             statusLed.classList.remove('led-on');
             statusLed.classList.add('led-off');
             updateStatusDisplay("OFF-HOOK");
             freqDisplay.textContent = '---'; // Reset frequency display
             canvasCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
             canvasCtx.fillStyle = '#111827'; // Match visualizer's bg-gray-900
             canvasCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height); // Clear with bg color
        }

        function visualize() {
            if (!analyser || !isRunning) return;

            animationFrameId = requestAnimationFrame(visualize);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            canvasCtx.fillStyle = '#111827'; // bg-gray-900
            canvasCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);

            const barWidth = (visualizerCanvas.width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i];
                
                // Color based on state
                if(isTrunkSeized) {
                    canvasCtx.fillStyle = 'rgb(239, 68, 68)'; // red-500
                } else {
                    canvasCtx.fillStyle = 'rgb(59, 130, 246)'; // blue-500
                }

                canvasCtx.fillRect(x, visualizerCanvas.height - barHeight / 2, barWidth, barHeight / 2);
                x += barWidth + 1;
            }
        }
        
        // --- Event Listeners ---
        startButton.addEventListener('click', async () => {
            if (isRunning) return;
            logToDisplay("Initializing...");
            try {
                // If Tone.context exists (it should after first import/load)
                // and has an 'open' method, call it. This is crucial for re-initializing
                // the native AudioContext if it was closed by a previous dispose/close.
                if (Tone.context && typeof Tone.context.open === 'function') {
                    await Tone.context.open();
                }
                await Tone.start(); // Ensure AudioContext is started/resumed by user gesture.
                logToDisplay("Audio context started.");
                await startAudioProcessing(); // Now proceed with app-specific audio setup
            } catch (error) {
                logToDisplay("Error starting audio. Please try again.");
                console.error("Error on Tone.start() or startAudioProcessing():", error);
                // Optionally re-enable start button if start failed critically
                startButton.disabled = false;
                startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        hangupButton.addEventListener('click', () => {
            if (!isRunning) return;
            logToDisplay("Hanging up...");
            stopAudioProcessing(); // Call the async function
        });

        const playTone2600 = () => {
            if (tone2600 && isRunning && tone2600.state !== "started") {
                tone2600.start();
            }
        };

        const stopTone2600 = () => {
            if (tone2600 && tone2600.state === "started") {
                tone2600.stop();
            }
        };

        play2600Button.addEventListener('mousedown', playTone2600);
        play2600Button.addEventListener('mouseup', stopTone2600);
        play2600Button.addEventListener('mouseleave', stopTone2600); // Stop if mouse leaves while pressed

        // Touch events for mobile
        play2600Button.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent triggering mouse events as well
            playTone2600();
        });
        play2600Button.addEventListener('touchend', stopTone2600);
        play2600Button.addEventListener('touchcancel', stopTone2600);

        muteToggleLink.addEventListener('click', () => {
            isDialToneMuted = !isDialToneMuted; // Toggle the state

            if (isDialToneMuted) {
                logToDisplay("Dial tone muted.");
                // If dial tone was playing (text would be "DIAL TONE" before mute), stop it.
                if (dialTone && typeof dialTone.releaseAll === 'function') {
                    dialTone.releaseAll(); // Stop dial tone if it's currently playing
                }
            } else {
                logToDisplay("Dial tone unmuted.");
                // If the system is in a state where dial tone should be playing, play it.
                if (isRunning && !isTrunkSeized) {
                    playDialTone(); // This will play it since isDialToneMuted is now false
                }
            }
            // Update the display based on the new mute state, assuming base state is "DIAL TONE"
            updateStatusDisplay("DIAL TONE");
        });

        // Initial UI state
        updateUIForHangup();
        logToDisplay("System Idle.");
        logToDisplay("Press START to begin.");

    </script>
</body>
</html>
